(function(){var $m=mxn.util.$m,init=function(){this.invoker.go("init",[this.currentElement,this.api]),this.applyOptions()},Mapstraction=mxn.Mapstraction=function(t,e,i){e||(e=mxn.util.getAvailableProviders()[0]),this.api=e,this.maps={},this.currentElement=$m(t),this.eventListeners=[],this.tileLayers=[],this.markers=[],this.polylines=[],this.Chartss=[],this.wms=[],this.images=[],this.controls=[],this.loaded={},this.onload={},this.onload[e]=[],this.element=t,this.options={enableScrollWheelZoom:!0,enableDragging:!0},this.addControlsArgs={},this.invoker=new mxn.Invoker(this,"Mapstraction",function(){return this.api}),mxn.addEvents(this,["load","click","endPan","changeZoom","markerAdded","markerRemoved","polylineAdded","ChartsAdded","polylineRemoved","ChartsRemoved","wmsAdded"]),init.apply(this)};Mapstraction.ROAD=1,Mapstraction.SATELLITE=2,Mapstraction.HYBRID=3,Mapstraction.PHYSICAL=4,mxn.addProxyMethods(Mapstraction,["addLargeControls","addMapTypeControls","addOverlay","addSmallControls","applyOptions","getBounds","getCenter","getMapType","getPixelRatio","getZoom","getZoomLevelForBoundingBox","mousePosition","resizeTo","setBounds","setCenter","setCenterAndZoom","setMapType","setZoom","setInvalidateSize","toggleTileLayer","addDistance","addSearch"]),Mapstraction.prototype.setOptions=function(t){mxn.util.merge(this.options,t),this.applyOptions()},Mapstraction.prototype.setOption=function(t,e){this.options[t]=e,this.applyOptions()},Mapstraction.prototype.enableScrollWheelZoom=function(){this.setOption("enableScrollWheelZoom",!0)},Mapstraction.prototype.dragging=function(t){this.setOption("enableDragging",t)},Mapstraction.prototype.swap=function(t,e){if(this.api!==e){var i=this.getCenter(),o=this.getZoom();if(this.currentElement.style.visibility="hidden",this.currentElement.style.display="none",this.currentElement=$m(t),this.currentElement.style.visibility="visible",this.currentElement.style.display="block",this.api=e,this.onload[e]=[],this.maps.hasOwnProperty(this.api))this.setCenterAndZoom(i,o);else{init.apply(this);for(var s=0;s<this.markers.length;s++)this.addMarker(this.markers[s],!0);for(s=0;s<this.markersText.length;s++)this.addMarkerText(this.markersText[s],!0);for(var r=0;r<this.polylines.length;r++)this.addPolyline(this.polylines[r],!0);for(r=0;r<this.Chartss.length;r++)this.addCharts(this.Chartss[r],!0);for(r=0;r<this.wms.length;r++)this.addWMS(this.wms[r],!0);this.setCenterAndZoom(i,o)}this.addControls(this.addControlsArgs)}},Mapstraction.prototype.isLoaded=function(t){return null===t&&(t=this.api),this.loaded[t]},Mapstraction.prototype.setDebug=function(t){return null!==t&&(this.debug=t),this.debug},Mapstraction.prototype.setDefer=function(t){this.loaded[this.api]=!t},Mapstraction.prototype.runDeferred=function(){for(;this.onload[this.api].length>0;)this.onload[this.api].shift().apply(this)},Mapstraction.prototype.clickHandler=function(t,e,i){this.callEventListeners("click",{location:new LatLonPoint(t,e)})},Mapstraction.prototype.moveendHandler=function(t){this.callEventListeners("moveend",{})},Mapstraction.prototype.addEventListener=function(){var t={};t.event_type=arguments[0],t.callback_function=arguments[1],3==arguments.length?(t.back_compat_mode=!1,t.callback_object=arguments[2]):(t.back_compat_mode=!0,t.callback_object=null),this.eventListeners.push(t)},Mapstraction.prototype.callEventListeners=function(t,e){e.source=this;for(var i=0;i<this.eventListeners.length;i++){var o=this.eventListeners[i];if(o.event_type==t)if(o.back_compat_mode)"click"==o.event_type?o.callback_function(e.location):o.callback_function();else{var s=o.callback_object||this;o.callback_function.call(s,e)}}},Mapstraction.prototype.addControls=function(t){this.addControlsArgs=t,this.invoker.go("addControls",arguments)},Mapstraction.prototype.addMarker=function(t,e){t.mapstraction=this,t.api=this.api,t.location.api=this.api,t.map=this.maps[this.api];var i=this.invoker.go("addMarker",arguments);t.setChild(i),e||this.markers.push(t),this.markerAdded.fire({marker:t})},Mapstraction.prototype.addMarkerText=function(t,e){t.mapstraction=this,t.api=this.api,t.location.api=this.api,t.map=this.maps[this.api];var i=this.invoker.go("addMarkerText",arguments);t.setChild(i),e||this.markersText.push(t),this.markerAdded.fire({markerText:t})},Mapstraction.prototype.addMarkerWithData=function(t,e){t.addData(e),this.addMarker(t)},Mapstraction.prototype.addMarkerTextWithData=function(t,e){markerText.addData(e),this.addMarkerText(t)},Mapstraction.prototype.addPolylineWithData=function(t,e){t.addData(e),this.addPolyline(t)},Mapstraction.prototype.removeMarker=function(t){this.invoker.go("removeMarker",arguments),t.onmap=!1,this.markerRemoved.fire({marker:t})},Mapstraction.prototype.removeAllMarkers=function(){for(var t;this.markers.length>0;)t=this.markers.pop(),this.invoker.go("removeMarker",[t])},Mapstraction.prototype.declutterMarkers=function(t){if(!1!==this.loaded[this.api]){var e=this.maps[this.api];switch(this.api){case"multimap":e.declutterGroup(t.groupName);break;case"  dummy":break;default:this.debug&&alert(this.api+" not supported by Mapstraction.declutterMarkers")}}else{var i=this;this.onload[this.api].push(function(){i.declutterMarkers(t)})}},Mapstraction.prototype.addPolyline=function(t,e){t.api=this.api,t.map=this.maps[this.api];var i=this.invoker.go("addPolyline",arguments);t.setChild(i),e||this.polylines.push(t),this.polylineAdded.fire({polyline:t})},Mapstraction.prototype.addCharts=function(t,e){t.api=this.api,t.map=this.maps[this.api];var i=this.invoker.go("addCharts",arguments);t.setChild(i),e||this.Chartss.push(t),this.ChartsAdded.fire({charts:t})},Mapstraction.prototype.addWMS=function(t,e){t.api=this.api,t.map=this.maps[this.api];var i=this.invoker.go("addWMS",arguments);t.setChild(i),e||this.wms.push(t),this.wmsAdded.fire({wms:t})};var removePolylineImpl=function(t){this.invoker.go("removePolyline",arguments),t.onmap=!1,this.polylineRemoved.fire({polyline:t})},removeChartsImpl=function(t){this.invoker.go("removeCharts",arguments),t.onmap=!1,this.ChartsRemoved.fire({Charts:t})},removeWMSImpl=function(t){this.invoker.go("removeWMS",arguments),t.onmap=!1,this.ChartsRemoved.fire({wms:t})};Mapstraction.prototype.removePolyline=function(t){for(var e,i=0;i<this.polylines.length;i++)if(e=this.polylines[i],t==e){this.polylines.splice(i,1),removePolylineImpl.call(this,t);break}},Mapstraction.prototype.removeCharts=function(t){for(var e,i=0;i<this.Chartss.length;i++)if(e=this.Chartss[i],t==e){this.Chartss.splice(i,1),removeChartsImpl.call(this,t);break}},Mapstraction.prototype.removeWMS=function(t){for(var e=0;e<this.wms.length;e++)if(current_WMS=this.wms[e],t==current_WMS){this.wms.splice(e,1),removeWMSImpl.call(this,t);break}},Mapstraction.prototype.removeAllPolylines=function(){for(var t;this.polylines.length>0;)t=this.polylines.pop(),removePolylineImpl.call(this,t)},Mapstraction.prototype.removeAllChartss=function(){for(var t;this.Chartss.length>0;)t=this.Chartss.pop(),removeChartsImpl.call(this,t)},Mapstraction.prototype.removeAllWMS=function(){for(var t;this.wms.length>0;)current_wms=this.wms.pop(),removeWMSImpl.call(this,t)};var collectPoints=function(t,e,i){var o=[];if(t)for(var s=0;s<this.markers.length;s++){var r=this.markers[s];i&&!i(r)||o.push(r.location)}if(e)for(s=0;s<this.polylines.length;s++){var n=this.polylines[s];if(!i||i(n))for(var a=0;a<n.points.length;a++)o.push(n.points[a])}return o};Mapstraction.prototype.autoCenterAndZoom=function(){var t=collectPoints.call(this,!0,!0);this.centerAndZoomOnPoints(t)},Mapstraction.prototype.centerAndZoomOnPoints=function(t){for(var e=new BoundingBox(90,180,-90,-180),i=0,o=t.length;i<o;i++)e.extend(t[i]);this.setBounds(e)},Mapstraction.prototype.visibleCenterAndZoom=function(){var t=function(t){return t.getAttribute("visible")},e=collectPoints.call(this,!0,!0,t);this.centerAndZoomOnPoints(e)},Mapstraction.prototype.polylineCenterAndZoom=function(t){t=t||0;var e=collectPoints.call(this,!1,!0);if(t>0){for(var i=[],o=0;o<e.length;o++){var s=e[o],r=s.latConv(),n=s.lonConv(),a=t/r,l=t/n,h=new LatLonPoint(s.lat+a,s.lon+l),p=new LatLonPoint(s.lat-a,s.lon-l);i.push(h,p)}e=e.concat(i)}this.centerAndZoomOnPoints(e)},Mapstraction.prototype.addImageOverlay=function(t,e,i,o,s,r,n){var a=document.createElement("img");a.style.display="block",a.setAttribute("id",t),a.setAttribute("src",e),a.style.position="absolute",a.style.zIndex=1,a.setAttribute("west",o),a.setAttribute("south",s),a.setAttribute("east",r),a.setAttribute("north",n);var l={imgElm:a};this.invoker.go("addImageOverlay",arguments,{context:l})},Mapstraction.prototype.setImageOpacity=function(t,e){e<0&&(e=0),e>=100&&(e=100);var i=e/100,o=document.getElementById(t);"string"==typeof o.style.filter&&(o.style.filter="alpha(opacity:"+e+")"),"string"==typeof o.style.KHTMLOpacity&&(o.style.KHTMLOpacity=i),"string"==typeof o.style.MozOpacity&&(o.style.MozOpacity=i),"string"==typeof o.style.opacity&&(o.style.opacity=i)},Mapstraction.prototype.setImagePosition=function(t){var e=document.getElementById(t),i={latLng:{top:e.getAttribute("north"),left:e.getAttribute("west"),bottom:e.getAttribute("south"),right:e.getAttribute("east")},pixels:{top:0,right:0,bottom:0,left:0}};this.invoker.go("setImagePosition",arguments,{context:i}),e.style.top=i.pixels.top.toString()+"px",e.style.left=i.pixels.left.toString()+"px",e.style.width=(i.pixels.right-i.pixels.left).toString()+"px",e.style.height=(i.pixels.bottom-i.pixels.top).toString()+"px"},Mapstraction.prototype.addJSON=function(json){var features;features="string"==typeof json?eval("("+json+")"):json,features=features.features;var map=this.maps[this.api],html="",item,polyline,marker,markers=[];"FeatureCollection"==features.type&&this.addJSON(features.features);for(var i=0;i<features.length;i++)switch(item=features[i],item.geometry.type){case"Point":html="<strong>"+item.title+"</strong><p>"+item.description+"</p>",marker=new Marker(new LatLonPoint(item.geometry.coordinates[1],item.geometry.coordinates[0])),markers.push(marker),this.addMarkerWithData(marker,{infoBubble:html,label:item.title,date:'new Date("'+item.date+'")',iconShadow:item.icon_shadow,marker:item.id,iconShadowSize:item.icon_shadow_size,icon:item.icon,iconSize:item.icon_size,category:item.source_id,draggable:!1,hover:!1});break;case"Polygon":var points=[];polyline=new Polyline(points),mapstraction.addPolylineWithData(polyline,{fillColor:item.poly_color,date:'new Date("'+item.date+'")',category:item.source_id,width:item.line_width,opacity:item.line_opacity,color:item.line_color,polygon:!0}),markers.push(polyline)}return markers},Mapstraction.prototype.addTileLayer=function(t,e,i,o,s,r){if(t)return e=e||.6,i=i||"Mapstraction",o=o||1,s=s||18,r=r||!1,this.invoker.go("addTileLayer",[t,e,i,o,s,r])},Mapstraction.prototype.removeTileLayer=function(){return this.invoker.go("removeTileLayer")},Mapstraction.prototype.addFilter=function(t,e,i){this.filters||(this.filters=[]),this.filters.push([t,e,i])},Mapstraction.prototype.removeFilter=function(t,e,i){if(this.filters)for(var o=0;o<this.filters.length;o++)this.filters[o][0]!=t||e&&(this.filters[o][1]!=e||this.filters[o][2]!=i)||(this.filters.splice(o,1),o--)},Mapstraction.prototype.toggleFilter=function(t,e,i){this.filters||(this.filters=[]);for(var o=!1,s=0;s<this.filters.length;s++)this.filters[s][0]==t&&this.filters[s][1]==e&&this.filters[s][2]==i&&(this.filters.splice(s,1),s--,o=!0);o||this.addFilter(t,e,i)},Mapstraction.prototype.removeAllFilters=function(){this.filters=[]},Mapstraction.prototype.doFilter=function(t,e){var i,o=this.maps[this.api],s=0;if(this.filters)switch(this.api){case"multimap":var r=[];for(i=0;i<this.filters.length;i++)r.push(new MMSearchFilter(this.filters[i][0],this.filters[i][1],this.filters[i][2]));o.setMarkerFilters(r),o.redrawMap();break;case"  dummy":break;default:for(var n,a=0;a<this.markers.length;a++){for(n=!0,i=0;i<this.filters.length;i++)this.applyFilter(this.markers[a],this.filters[i])||(n=!1);n?(s++,t?t(this.markers[a]):this.markers[a].show()):e?e(this.markers[a]):this.markers[a].hide(),this.markers[a].setAttribute("visible",n)}}return s},Mapstraction.prototype.applyFilter=function(t,e){var i=!0;switch(e[1]){case"ge":t.getAttribute(e[0])<e[2]&&(i=!1);break;case"le":t.getAttribute(e[0])>e[2]&&(i=!1);break;case"eq":t.getAttribute(e[0])==e[2]&&(i=!1)}return i},Mapstraction.prototype.getAttributeExtremes=function(t){for(var e,i,o=0;o<this.markers.length;o++)(!e||e>this.markers[o].getAttribute(t))&&(e=this.markers[o].getAttribute(t)),(!i||i<this.markers[o].getAttribute(t))&&(i=this.markers[o].getAttribute(t));for(var s=0;o<this.polylines.length;o++)(!e||e>this.polylines[s].getAttribute(t))&&(e=this.polylines[s].getAttribute(t)),(!i||i<this.polylines[s].getAttribute(t))&&(i=this.polylines[s].getAttribute(t));for(s=0;o<this.Chartss.length;o++)(!e||e>this.Chartss[s].getAttribute(t))&&(e=this.Chartss[s].getAttribute(t)),(!i||i<this.Chartss[s].getAttribute(t))&&(i=this.Chartss[s].getAttribute(t));return[e,i]},Mapstraction.prototype.getMap=function(){return this.maps[this.api]};var LatLonPoint=mxn.LatLonPoint=function(t,e){this.lat=Number(t),this.lon=Number(e),this.lng=this.lon,this.invoker=new mxn.Invoker(this,"LatLonPoint")};mxn.addProxyMethods(LatLonPoint,["fromProprietary","toProprietary"],!0),LatLonPoint.prototype.toString=function(){return this.lat+", "+this.lon},LatLonPoint.prototype.distance=function(t){var e=Math.PI/180,i=(this.lat-t.lat)*e,o=(this.lon-t.lon)*e,s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this.lat*e)*Math.cos(t.lat*e)*Math.sin(o/2)*Math.sin(o/2);return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371},LatLonPoint.prototype.equals=function(t){return this.lat==t.lat&&this.lon==t.lon},LatLonPoint.prototype.latConv=function(){return 10*this.distance(new LatLonPoint(this.lat+.1,this.lon))},LatLonPoint.prototype.lonConv=function(){return 10*this.distance(new LatLonPoint(this.lat,this.lon+.1))};var BoundingBox=mxn.BoundingBox=function(t,e,i,o){this.sw=new LatLonPoint(t,e),this.ne=new LatLonPoint(i,o)};BoundingBox.prototype.getSouthWest=function(){return this.sw},BoundingBox.prototype.getNorthEast=function(){return this.ne},BoundingBox.prototype.isEmpty=function(){return this.ne==this.sw},BoundingBox.prototype.contains=function(t){return t.lat>=this.sw.lat&&t.lat<=this.ne.lat&&t.lon>=this.sw.lon&&t.lon<=this.ne.lon},BoundingBox.prototype.toSpan=function(){return new LatLonPoint(Math.abs(this.sw.lat-this.ne.lat),Math.abs(this.sw.lon-this.ne.lon))},BoundingBox.prototype.extend=function(t){this.sw.lat>t.lat&&(this.sw.lat=t.lat),this.sw.lon>t.lon&&(this.sw.lon=t.lon),this.ne.lat<t.lat&&(this.ne.lat=t.lat),this.ne.lon<t.lon&&(this.ne.lon=t.lon)};var Marker=mxn.Marker=function(t){this.api=null,this.location=t,this.onmap=!1,this.proprietary_marker=!1,this.attributes=[],this.invoker=new mxn.Invoker(this,"Marker",function(){return this.api}),mxn.addEvents(this,["openInfoBubble","closeInfoBubble","click"])};mxn.addProxyMethods(Marker,["fromProprietary","hide","openBubble","closeBubble","show","toProprietary","update"]),Marker.prototype.setChild=function(t){this.proprietary_marker=t,t.mapstraction_marker=this,this.onmap=!0},Marker.prototype.setLabel=function(t){this.labelText=t},Marker.prototype.addData=function(t){for(var e in t)if(t.hasOwnProperty(e))switch(e){case"label":this.setLabel(t.label);break;case"infoBubble":this.setInfoBubble(t.infoBubble);break;case"icon":t.iconSize&&t.iconAnchor?this.setIcon(t.icon,t.iconSize,t.iconAnchor):t.iconSize?this.setIcon(t.icon,t.iconSize):this.setIcon(t.icon);break;case"iconShadow":t.iconShadowSize?this.setShadowIcon(t.iconShadow,[t.iconShadowSize[0],t.iconShadowSize[1]]):this.setIcon(t.iconShadow);break;case"infoDiv":this.setInfoDiv(t.infoDiv[0],t.infoDiv[1]);break;case"draggable":this.setDraggable(t.draggable);break;case"hover":this.setHover(t.hover);break;case"hoverIcon":this.setHoverIcon(t.hoverIcon);break;case"openBubble":this.openBubble();break;case"closeBubble":this.closeBubble();break;case"groupName":this.setGroupName(t.groupName);break;default:this.setAttribute(e,t[e])}},Marker.prototype.setInfoBubble=function(t){this.infoBubble=t},Marker.prototype.setInfoDiv=function(t,e){this.infoDiv=t,this.div=e},Marker.prototype.setIcon=function(t,e,i){this.iconUrl=t,e&&(this.iconSize=e),i&&(this.iconAnchor=i)},Marker.prototype.setIconSize=function(t){t&&(this.iconSize=t)},Marker.prototype.setIconAnchor=function(t){t&&(this.iconAnchor=t)},Marker.prototype.setShadowIcon=function(t,e){this.iconShadowUrl=t,e&&(this.iconShadowSize=e)},Marker.prototype.setHoverIcon=function(t){this.hoverIconUrl=t},Marker.prototype.setDraggable=function(t){this.draggable=t},Marker.prototype.setHover=function(t){this.hover=t},Marker.prototype.setGroupName=function(t){this.groupName=t},Marker.prototype.setAttribute=function(t,e){this.attributes[t]=e},Marker.prototype.getAttribute=function(t){return this.attributes[t]};var Polyline=mxn.Polyline=function(t){this.api=null,this.points=t,this.attributes=[],this.onmap=!1,this.proprietary_polyline=!1,this.pllID="mspll-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Math.pow(2,16)),this.invoker=new mxn.Invoker(this,"Polyline",function(){return this.api})};mxn.addProxyMethods(Polyline,["fromProprietary","hide","show","toProprietary","update"]),Polyline.prototype.addData=function(t){for(var e in t)if(t.hasOwnProperty(e))switch(e){case"color":this.setColor(t.color);break;case"width":this.setWidth(t.width);break;case"opacity":this.setOpacity(t.opacity);break;case"closed":this.setClosed(t.closed);break;case"fillColor":this.setFillColor(t.fillColor);break;default:this.setAttribute(e,t[e])}},Polyline.prototype.setChild=function(t){this.proprietary_polyline=t,this.onmap=!0},Polyline.prototype.setColor=function(t){this.color=7==t.length&&"#"==t[0]?t.toUpperCase():t},Polyline.prototype.setWidth=function(t){this.width=t},Polyline.prototype.setOpacity=function(t){this.opacity=t},Polyline.prototype.setClosed=function(t){this.closed=t},Polyline.prototype.setFillColor=function(t){this.fillColor=t},Polyline.prototype.setAttribute=function(t,e){this.attributes[t]=e},Polyline.prototype.getAttribute=function(t){return this.attributes[t]},Polyline.prototype.simplify=function(t){var e=[];e[0]=this.points[0];for(var i=0,o=1;o<this.points.length-1;o++)this.points[o].distance(this.points[i])>=t&&(e[e.length]=this.points[o],i=o);e[e.length]=this.points[this.points.length-1],this.points=e};var Charts=mxn.Charts=function(t){this.api=null,this.points=t,this.attributes=[],this.onmap=!1,this.proprietary_Charts=!1,this.pllID="mspll-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Math.pow(2,16)),this.invoker=new mxn.Invoker(this,"Charts",function(){return this.api})};mxn.addProxyMethods(Charts,["fromProprietary","hide","show","toProprietary","update"]);var Radius=mxn.Radius=function(t,e){this.center=t;var i=t.latConv(),o=t.lonConv(),s=Math.PI/180;this.calcs=[];for(var r=0;r<360;r+=e)this.calcs.push([Math.cos(r*s)/i,Math.sin(r*s)/o])};Radius.prototype.getPolyline=function(t,e){for(var i=[],o=0;o<this.calcs.length;o++){var s=new LatLonPoint(this.center.lat+t*this.calcs[o][0],this.center.lon+t*this.calcs[o][1]);i.push(s)}i.push(i[0]);var r=new Polyline(i);return r.setColor(e),r}})();